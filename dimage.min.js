/*! DImage.js v.1.2.0 - HTML5 Image Resize and Rotate Plugin | David Wei <weiguangchun@gmail.com> | https://github.com/cdiwo/DImage.js */
!function(){"use strict";var a=function(a,b,c){var h,d=this,e="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D",f=window.createObjectURL&&window||window.URL&&URL.revokeObjectURL&&URL||window.webkitURL,g={width:1280,height:1280,quality:90,preserveHeaders:!0,autoCompress:!1,debug:!1};for(h in b)g[h]=b[h];d.opts=g,d.debug=d.opts.debug,d.version="1.1.0",d.init=function(){var b=new Image;b.onload=function(){d._metas||"image/jpeg"!==d.type?d.inited():d.parse(a,function(a,b){a||(d._metas=b),d.inited()})},b.onerror=function(){console.log("image load error")},b.src=f.createObjectURL(a),d.type=a.type,d._img=b},d.inited=function(){d.opts.autoCompress&&d.resize(),c&&c(d)},d.destroy=function(){var a=this._canvas;this._img.onload=null,a&&(a.getContext("2d").clearRect(0,0,a.width,a.height),a.width=a.height=0,this._canvas=null),this._img.src=e,this._img=null},d.dataURL2Blob=function(a){var b,c,d,e,f,g;for(g=a.split(","),b=~g[0].indexOf("base64")?atob(g[1]):decodeURIComponent(g[1]),d=new ArrayBuffer(b.length),c=new Uint8Array(d),e=0;e<b.length;e++)c[e]=b.charCodeAt(e);return f=g[0].split(":")[1].split(";")[0],this.arrayBufferToBlob(d,f)},d.dataURL2ArrayBuffer=function(a){var b,c,d,e;for(e=a.split(","),b=~e[0].indexOf("base64")?atob(e[1]):decodeURIComponent(e[1]),c=new Uint8Array(b.length),d=0;d<b.length;d++)c[d]=b.charCodeAt(d);return c.buffer},d.arrayBufferToBlob=function(a,b){var d,c=window.BlobBuilder||window.WebKitBlobBuilder;return c?(d=new c,d.append(a),d.getBlob(b)):new Blob([a],b?{type:b}:{})},d.getAsBlob=function(){var c,d,e,a=this,b=this._canvas;try{if("image/jpeg"===this.type){if(c=b.toDataURL(this.type,a.opts.quality/100),a.opts.preserveHeaders&&this._metas&&this._metas.imageHead)return d=a.dataURL2ArrayBuffer(c),d=a.updateImageHead(d,this._metas.imageHead),e=a.arrayBufferToBlob(d,this.type)}else c=b.toDataURL(this.type);e=this.dataURL2Blob(c)}catch(f){}return e},d.getAsBase64=function(){var c,a=this,b=this._canvas;return c="image/jpeg"===a.type?b.toDataURL(a.type,a.opts.quality/100):b.toDataURL(a.type)},d.rotate=function(){var a=this._canvas||(this._canvas=document.createElement("canvas")),b=d._metas&&d._metas.orientation?d._metas.orientation:1;return 1!=b&&d._rotate(this._img,a,b),this},d._rotate=function(a,b,c){var e=b.getContext("2d"),f=b.width,g=b.height;switch(b.getAttribute("hasResetWH")||(f=a.width,g=a.height),c){case 6:b.width=g,b.height=f,e.rotate(Math.PI/2),e.drawImage(a,0,-g,f,g);break;case 8:b.width=g,b.height=f,e.rotate(-Math.PI/2),e.drawImage(a,-f,0,f,g);break;case 3:e.rotate(Math.PI),e.drawImage(a,-f,-g,f,g)}d.debug&&console.log("width, height, canvas.width, canvas.height",f,g,b.width,b.height)},d.resize=function(){var a=this._canvas||(this._canvas=document.createElement("canvas")),b=this._img,c=d.opts.width,e=d.opts.height;return d._resize(b,a,c,e),this},d._resize=function(a,b,c,e){var i,j,k,f=b.getContext("2d"),g=a.width,h=a.height;1>=c&&c>0&&(c=g*c),1>=e&&e>0&&(e=h*e),i=Math.min(c/g,e/h),i=Math.min(1,i),j=g*i,k=h*i,d.debug&&console.log("naturalHeight, naturalWidth, w, h",h,g,j,k),b.width=j,b.height=k,b.setAttribute("hasResetWH",!0),f.drawImage(a,0,0,j,k)},d.parse=function(a,b){var c=new FileReader,e=262144;c.onload=function(){b(!1,d._parse(this.result)),c=c.onload=c.onerror=null},c.onerror=function(a){b(a.message),c=c.onload=c.onerror=null},a=a.slice(0,e),c.readAsArrayBuffer(a)},d.readOrientationEXIFData=function(a,b){function c(a,b,c){var e,d="";for(e=b;b+c>e;e++)d+=String.fromCharCode(a.getUint8(e));return d}var e,f,g,k,l,m,h,i,j;if("Exif"!=c(a,b,4))return d.debug&&console.log("Not valid EXIF data! "+c(a,b,4)),!1;if(f=b+6,18761==a.getUint16(f))e=!0;else{if(19789!=a.getUint16(f))return d.debug&&console.log("Not valid TIFF data! (no 0x4949 or 0x4D4D)"),!1;e=!1}if(42!=a.getUint16(f+2,e))return d.debug&&console.log("Not valid TIFF data! (no 0x002A)"),!1;if(g=a.getUint32(f+4,e),8>g)return d.debug&&console.log("Not valid TIFF data! (First offset less than 8)",g),!1;for(h=1,i=f+g,j=a.getUint16(i,e),l=0;j>l;l++)k=i+12*l+2,m=a.getUint16(k,e),"0x0112"==m&&(h=a.getUint16(k+8,e));return h},d._parse=function(a){if(!(a.byteLength<6)){var g,h,b=new DataView(a),c=2,e=b.byteLength-4,f={};if(d.debug&&console.log("Got file of length "+a.byteLength),255!=b.getUint8(0)||216!=b.getUint8(1))return d.debug&&console.log("Not a valid JPEG"),f;if(65496===b.getUint16(0)){for(;e>c&&(g=b.getUint16(c),d.debug&&console.log(g),g>=65504&&65519>=g||65534===g)&&(65505==g&&(d.debug&&console.log("Found 0xFFE1 marker"),f.orientation=d.readOrientationEXIFData(b,c+4)),h=b.getUint16(c+2)+2,!(c+h>b.byteLength));)c+=h;c>6&&(f.imageHead=new Uint8Array(a).subarray(2,c))}return f}},d.updateImageHead=function(a,b){var e,f,c=this._parse(a),d=2;return c.imageHead&&(d+=c.imageHead.byteLength),f=new Uint8Array(a).subarray(d),e=new Uint8Array(b.byteLength+2+f.byteLength),e[0]=255,e[1]=216,e.set(new Uint8Array(b),2),e.set(new Uint8Array(f),b.byteLength+2),e.buffer},d.init()};a.create=function(b,c,d){return new a(b,c,d)},"function"==typeof define&&define.amd?define(function(){return a}):"undefined"!=typeof module&&module.exports?module.exports=a:("undefined"!=typeof window?window:this).DImage=a}();
